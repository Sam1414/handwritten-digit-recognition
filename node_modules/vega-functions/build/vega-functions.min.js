!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-expression"),require("d3-geo"),require("d3-color"),require("vega-dataflow"),require("vega-scale"),require("vega-scenegraph"),require("vega-selections"),require("vega-statistics"),require("vega-time"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression","d3-geo","d3-color","vega-dataflow","vega-scale","vega-scenegraph","vega-selections","vega-statistics","vega-time","d3-array"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).vega={},t.vega,t.vega,t.d3,t.d3,t.vega,t.vega,t.vega,t.vega,t.vega,t.vega,t.d3)}(this,(function(t,e,n,r,o,a,i,s,c,u,l,f){"use strict";function d(t){const e=this.context.data[t];return e?e.values.value:[]}function m(t,e,n){const r=this.context.data[t]["index:"+e],o=r?r.value.get(n):void 0;return o?o.count:o}function g(t,n){const r=this.context.dataflow,o=this.context.data[t].input;return r.pulse(o,r.changeset().remove(e.truthy).insert(n)),1}function p(t,e,n){if(t){const n=this.context.dataflow,r=t.mark.source;n.pulse(r,n.changeset().encode(t,e))}return void 0!==n?n:t}const h=t=>function(e,n){return this.context.dataflow.locale()[t](n)(e)},v=h("format"),y=h("timeFormat"),b=h("utcFormat"),x=h("timeParse"),w=h("utcParse"),S=new Date(2e3,0,1);function q(t,e,n){return Number.isInteger(t)&&Number.isInteger(e)?(S.setYear(2e3),S.setMonth(t),S.setDate(e),y.call(this,S,n)):""}function P(t){return q.call(this,t,1,"%B")}function N(t){return q.call(this,t,1,"%b")}function L(t){return q.call(this,0,2+t,"%A")}function A(t){return q.call(this,0,2+t,"%a")}const F="%";function k(t,r,o,a){r[0].type!==n.Literal&&e.error("First argument to data functions must be a string literal.");const i=r[0].value,s=":"+i;if(!e.hasOwnProperty(s,a))try{a[s]=o.getData(i).tuplesRef()}catch(t){}}function _(t,r,o,a){r[0].type!==n.Literal&&e.error("First argument to indata must be a string literal."),r[1].type!==n.Literal&&e.error("Second argument to indata must be a string literal.");const i=r[0].value,s=r[1].value,c="@"+s;e.hasOwnProperty(c,a)||(a[c]=o.getData(i).indataRef(o,s))}function O(t,e,r,o){if(e[0].type===n.Literal)R(r,o,e[0].value);else for(t in r.scales)R(r,o,t)}function R(t,n,r){const o=F+r;if(!e.hasOwnProperty(n,o))try{n[o]=t.scaleRef(r)}catch(t){}}function z(t,n){let r;return e.isFunction(t)?t:e.isString(t)?(r=n.scales[t])&&r.value:void 0}function D(t,r,o){r.__bandwidth=t=>t&&t.bandwidth?t.bandwidth():0,o._bandwidth=O,o._range=O,o._scale=O;const a=r=>"_["+(r.type===n.Literal?e.stringValue(F+r.value):e.stringValue(F)+"+"+t(r))+"]";return{_bandwidth:t=>`this.__bandwidth(${a(t[0])})`,_range:t=>a(t[0])+".range()",_scale:e=>`${a(e[0])}(${t(e[1])})`}}function E(t,e){return function(n,r,o){if(n){const e=z(n,(o||this).context);return e&&e.path[t](r)}return e(r)}}const U=E("area",r.geoArea),V=E("bounds",r.geoBounds),$=E("centroid",r.geoCentroid);function B(t){const e=this.context.group;let n=!1;if(e)for(;t;){if(t===e){n=!0;break}t=t.mark.group}return n}function M(t,e,n){try{t[e].apply(t,["EXPRESSION"].concat([].slice.call(n)))}catch(e){t.warn(e)}return n[n.length-1]}function T(){return M(this.context.dataflow,"warn",arguments)}function j(){return M(this.context.dataflow,"info",arguments)}function C(){return M(this.context.dataflow,"debug",arguments)}function X(t){const e=t/255;return e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Y(t){const e=o.rgb(t);return.2126*X(e.r)+.7152*X(e.g)+.0722*X(e.b)}function I(t,e){const n=Y(t),r=Y(e);return(Math.max(n,r)+.05)/(Math.min(n,r)+.05)}function G(){const t=[].slice.call(arguments);return t.unshift({}),e.extend.apply(null,t)}function H(t,n){return t===n||t!=t&&n!=n||(e.isArray(t)?!(!e.isArray(n)||t.length!==n.length)&&function(t,e){for(let n=0,r=t.length;n<r;++n)if(!H(t[n],e[n]))return!1;return!0}(t,n):!(!e.isObject(t)||!e.isObject(n))&&W(t,n))}function W(t,e){for(const n in t)if(!H(t[n],e[n]))return!1;return!0}function J(t){return e=>W(t,e)}function K(t,n,r,o,i,s){const c=this.context.dataflow,u=this.context.data[t],l=u.input,f=c.stamp();let d,m,g=u.changes;if(!1===c._trigger||!(l.value.length||n||o))return 0;if((!g||g.stamp<f)&&(u.changes=g=c.changeset(),g.stamp=f,c.runAfter(()=>{u.modified=!0,c.pulse(l,g).run()},!0,1)),r&&(d=!0===r?e.truthy:e.isArray(r)||a.isTuple(r)?r:J(r),g.remove(d)),n&&g.insert(n),o&&(d=J(o),l.value.some(d)?g.remove(d):g.insert(o)),i)for(m in s)g.modify(i,m,s[m]);return 1}function Q(t){const e=t.touches,n=e[0].clientX-e[1].clientX,r=e[0].clientY-e[1].clientY;return Math.sqrt(n*n+r*r)}function Z(t){const e=t.touches;return Math.atan2(e[0].clientY-e[1].clientY,e[0].clientX-e[1].clientX)}function tt(t,e,n){return i.bandSpace(t||0,e||0,n||0)}function et(t,e){const n=z(t,(e||this).context);return n&&n.bandwidth?n.bandwidth():0}function nt(t,e){const n=z(t,(e||this).context);return n?n.copy():void 0}function rt(t,e){const n=z(t,(e||this).context);return n?n.domain():[]}function ot(t,n,r){const o=z(t,(r||this).context);return o?e.isArray(n)?(o.invertRange||o.invert)(n):(o.invert||o.invertExtent)(n):void 0}function at(t,e){const n=z(t,(e||this).context);return n&&n.range?n.range():[]}function it(t,e,n){const r=z(t,(n||this).context);return r?r(e):void 0}function st(t,n,r,o,a){t=z(t,(a||this).context);const c=s.Gradient(n,r);let u=t.domain(),l=u[0],f=e.peek(u),d=e.identity;return f-l?d=i.scaleFraction(t,l,f):t=(t.interpolator?i.scale("sequential")().interpolator(t.interpolator()):i.scale("linear")().interpolate(t.interpolate()).range(t.range())).domain([l=0,f=1]),t.ticks&&(u=t.ticks(+o||15),l!==u[0]&&u.unshift(l),f!==e.peek(u)&&u.push(f)),u.forEach(e=>c.stop(d(e),t(e))),c}function ct(t,e,n){const r=z(t,(n||this).context);return function(t){return r?r.path.context(t)(e):""}}function ut(t){let e=null;return function(n){return n?s.pathRender(n,e=e||s.pathParse(t)):t}}const lt=t=>t.data;function ft(t,e){const n=d.call(e,t);return n.root&&n.root.lookup||{}}function dt(t,e,n){const r=ft(t,this),o=r[e],a=r[n];return o&&a?o.path(a).map(lt):void 0}function mt(t,e){const n=ft(t,this)[e];return n?n.ancestors().map(lt):void 0}const gt=()=>"undefined"!=typeof window&&window||null;function pt(){const t=gt();return t?t.screen:{}}function ht(){const t=gt();return t?[t.innerWidth,t.innerHeight]:[void 0,void 0]}function vt(){const t=this.context.dataflow,e=t.container&&t.container();return e?[e.clientWidth,e.clientHeight]:[void 0,void 0]}const yt={random:()=>u.random(),cumulativeNormal:u.cumulativeNormal,cumulativeLogNormal:u.cumulativeLogNormal,cumulativeUniform:u.cumulativeUniform,densityNormal:u.densityNormal,densityLogNormal:u.densityLogNormal,densityUniform:u.densityUniform,quantileNormal:u.quantileNormal,quantileLogNormal:u.quantileLogNormal,quantileUniform:u.quantileUniform,sampleNormal:u.sampleNormal,sampleLogNormal:u.sampleLogNormal,sampleUniform:u.sampleUniform,isArray:e.isArray,isBoolean:e.isBoolean,isDate:e.isDate,isDefined:t=>void 0!==t,isNumber:e.isNumber,isObject:e.isObject,isRegExp:e.isRegExp,isString:e.isString,isTuple:a.isTuple,isValid:t=>null!=t&&t==t,toBoolean:e.toBoolean,toDate:e.toDate,toNumber:e.toNumber,toString:e.toString,flush:e.flush,lerp:e.lerp,merge:G,pad:e.pad,peek:e.peek,span:e.span,inrange:e.inrange,truncate:e.truncate,rgb:o.rgb,lab:o.lab,hcl:o.hcl,hsl:o.hsl,luminance:Y,contrast:I,sequence:f.range,format:v,utcFormat:b,utcParse:w,utcOffset:l.utcOffset,utcSequence:l.utcSequence,timeFormat:y,timeParse:x,timeOffset:l.timeOffset,timeSequence:l.timeSequence,timeUnitSpecifier:l.timeUnitSpecifier,monthFormat:P,monthAbbrevFormat:N,dayFormat:L,dayAbbrevFormat:A,quarter:e.quarter,utcquarter:e.utcquarter,week:l.week,utcweek:l.utcweek,dayofyear:l.dayofyear,utcdayofyear:l.utcdayofyear,warn:T,info:j,debug:C,extent:e.extent,inScope:B,intersect:function(t,n,r){if(!t)return[];const[o,a]=t,i=(new s.Bounds).set(o[0],o[1],a[0],a[1]),c=r||this.context.dataflow.scenegraph().root;return s.intersect(c,i,function(t){let n=null;if(t){const r=e.array(t.marktype),o=e.array(t.markname);n=t=>(!r.length||r.some(e=>t.marktype===e))&&(!o.length||o.some(e=>t.name===e))}return n}(n))},clampRange:e.clampRange,pinchDistance:Q,pinchAngle:Z,screen:pt,containerSize:vt,windowSize:ht,bandspace:tt,setdata:g,pathShape:ut,panLinear:e.panLinear,panLog:e.panLog,panPow:e.panPow,panSymlog:e.panSymlog,zoomLinear:e.zoomLinear,zoomLog:e.zoomLog,zoomPow:e.zoomPow,zoomSymlog:e.zoomSymlog,encode:p,modify:K},bt=["view","item","group","xy","x","y"],xt="this.",wt={},St={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:t=>`_[${e.stringValue("$"+t)}]`,functions:function(t){const r=n.functions(t);bt.forEach(t=>r[t]="event.vega."+t);for(const t in yt)r[t]=xt+t;return e.extend(r,D(t,yt,wt)),r},constants:n.constants,visitors:wt},qt=n.codegen(St);function Pt(t,e,n){return 1===arguments.length?yt[t]:(yt[t]=e,n&&(wt[t]=n),qt&&(qt.functions[t]=xt+t),this)}Pt("bandwidth",et,O),Pt("copy",nt,O),Pt("domain",rt,O),Pt("range",at,O),Pt("invert",ot,O),Pt("scale",it,O),Pt("gradient",st,O),Pt("geoArea",U,O),Pt("geoBounds",V,O),Pt("geoCentroid",$,O),Pt("geoShape",ct,O),Pt("indata",m,_),Pt("data",d,k),Pt("treePath",dt,k),Pt("treeAncestors",mt,k),Pt("vlSelectionTest",c.selectionTest,c.selectionVisitor),Pt("vlSelectionResolve",c.selectionResolve,c.selectionVisitor),t.DataPrefix=":",t.IndexPrefix="@",t.ScalePrefix=F,t.SignalPrefix="$",t.bandspace=tt,t.bandwidth=et,t.codeGenerator=qt,t.codegenParams=St,t.containerSize=vt,t.contrast=I,t.copy=nt,t.data=d,t.dataVisitor=k,t.dayAbbrevFormat=A,t.dayFormat=L,t.debug=C,t.domain=rt,t.encode=p,t.expressionFunction=Pt,t.format=v,t.functionContext=yt,t.geoArea=U,t.geoBounds=V,t.geoCentroid=$,t.geoShape=ct,t.inScope=B,t.indata=m,t.indataVisitor=_,t.info=j,t.invert=ot,t.luminance=Y,t.merge=G,t.modify=K,t.monthAbbrevFormat=N,t.monthFormat=P,t.parseExpression=function(t,r){const o={};let a;try{t=e.isString(t)?t:e.stringValue(t)+"",a=n.parse(t)}catch(n){e.error("Expression parse error: "+t)}a.visit(t=>{if(t.type!==n.CallExpression)return;const e=t.callee.name,a=St.visitors[e];a&&a(e,t.arguments,r,o)});const i=qt(a);return i.globals.forEach(t=>{const n="$"+t;!e.hasOwnProperty(o,n)&&r.getSignal(t)&&(o[n]=r.signalRef(t))}),{$expr:e.extend({code:i.code},r.options.ast?{ast:a}:null),$fields:i.fields,$params:o}},t.pathShape=ut,t.pinchAngle=Z,t.pinchDistance=Q,t.range=at,t.scale=it,t.scaleGradient=st,t.scaleVisitor=O,t.screen=pt,t.setdata=g,t.timeFormat=y,t.timeParse=x,t.treeAncestors=mt,t.treePath=dt,t.utcFormat=b,t.utcParse=w,t.warn=T,t.windowSize=ht,Object.defineProperty(t,"__esModule",{value:!0})}));